---
layout:     post
title:      Hammer time： Nailing the emcee ensemble sampler onto PyMC
subtitle:   转载自：http://twiecki.github.com/blog/2013/09/23/emcee-pymc/
date:       2013-09-23
author:     Thomas Wiecki
header-img: img/background2.jpg
catalog: true
tags:
    - pymc
    - models
    - samplers
    - emcee
    - ensemble sampler
---





tl;dr: I hacked the [`emcee`--The MCMC-Hammer](http://dan.iel.fm/emcee) ensemble sampler to work on `PyMC` models.

## Motivation[¶](http://twiecki.github.com/blog/2013/09/23/emcee-pymc#Motivation)

[`PyMC`](http://pymc-devs.github.io/pymc) is an awesome Python module to perform Bayesian inference. It allows for flexible model creation and has basic MCMC samplers like [Metropolis-Hastings](http://en.wikipedia.org/wiki/Metropolis%E2%80%93Hastings_algorithm). The upcoming PyMC3 will feature much fancier samplers like [Hamiltonian-Monte Carlo (HMC)](http://en.wikipedia.org/wiki/Hybrid_Monte_Carlo) that are all the rave these days. While those HMC samplers are very powerful for complex models with lots of dimensions, they also require gradient information of the posterior. AutoDiff (as part of `Theano`) makes this very easy for exponential family models.

However, in the real world of Big Science, we often do not have likelihoods from the exponential family. For example, the likelihood function of [HDDM](http://ski.clps.brown.edu/hddm_docs) -- our toolbox to do hierarchical Bayesian estimation of a decision making model often used in mathematical psychology -- has an infinite sum and requires numerical integration which make it non-differentiable. In many other areas of science, likelihoods result from complex non-linear models that take a while to compute as described in this [recent post on Andrew Gelman's blog](http://andrewgelman.com/2013/09/12/samplers-big-science-emcee-bat).

Largely separated from the hype around HMC that machine learners and statisticians love, astrophysicists have been solving this problems in other ways. [Ensemble Samplers with Affine Invariance](http://msp.org/camcos/2010/5-1/camcos-v5-n1-p04-p.pdf) do not require gradient information but instead run many samplers (called "walkers" -- Walking Dead, anyone?) in parallel to cover the space. With expensive likelihoods, having parallel sampling (something that's not possible with HMC yet) is a game changer.

For a fun visual depiction of HMC vs Ensemble Samplers, see these two videos (make sure to crank your speakers to the max and dance as if the NSA wasn't watching):




### Hamiltonian Monte Carlo sampler[¶](http://twiecki.github.com/blog/2013/09/23/emcee-pymc#Hamiltonian-Monte-Carlo-sampler)

In [2]:




### Affine Invariant Ensemble sampler[¶](http://twiecki.github.com/blog/2013/09/23/emcee-pymc#Affine-Invariant-Ensemble-sampler)

In [1]:




While `PyMC` does not have support for these Ensemble Samplers, there is [`emcee` -- The MCMC Hammer](http://dan.iel.fm/emcee) which implements it. `emcee` however only has the sampler, it currently lacks the model specification capabilities and probability distributions that `PyMC` offers. It is thus an obvious idea to try and combine the emcee sampler with the `PyMC` functionality for model building. This here is a very dirty hack that does just that.

In [8]:



/usr/local/lib/python2.7/dist-packages/scikits/__init__.py:1: UserWarning: Module mpl_toolkits was already imported from None, but /usr/local/lib/python2.7/dist-packages is being added to sys.path
 __import__('pkg_resources').declare_namespace(__name__)









This is copy pasted from the bioessay_gelman.py example of `PyMC`.

In [9]:




Build and sample from the model the PyMC way to see that the outcome between the Metropolis-Hastings sampler and emcee are the same.

In [10]:



[****************100%******************] 5000 of 5000 completePlotting alpha
Plotting beta

















OK, you have been warned.

The central trick is to use the PyMC model to compute the logp of the model. We set the parameters externally and call `.logp` which we pass to the emcee sampler.

In [11]:



[ 0% ]Plotting alpha
Plotting beta
















We get the same posterior back as with `PyMC` which is encouraging. The autocorrelation is also lower (with a high number of walkers, looks worse with fewer walkers) although I expected it to be even lower as this is a big selling point for `emcee`.

## HMC vs Affine Invariant Ensemble samplers[¶](http://twiecki.github.com/blog/2013/09/23/emcee-pymc#HMC-vs-Affine-Invariant-Ensemble-samplers)

I think HMC and Ensemble samplers are both relevant, albeit in different domains. Without having done any experiments, I expect HMC to do well for exponential family models with high dimensions and complex posteriors. Ensemble samplers can deal with non-differentiable, expensive to compute likelihood functions as they often appear in science. They can not escape the curse of dimensionality, however, as the size of the space grows exponentially but adding walkers only scales linear.




## Future directions[¶](http://twiecki.github.com/blog/2013/09/23/emcee-pymc#Future-directions)

- `emcee` could be included into `PyMC` as a [custom step method](https://pymcmc.readthedocs.org/en/jss-gp/extending.html#user-defined-step-methods) which would reduce the hackiness.

- Parallelization: For me the biggest selling point for Ensemble Samplers is that they can be parallelized quite easily (something not possible for HMC). This helps especially with expensive likelihoods that can require simulation to evaluate. `emcee` already has support for this but the `lnprob` function must be pickable and `PyMC` models are not pickable. It is possible, however, to recreate a `PyMC` model in each process. This would be quite easy with this hack but doesn't seem as straight forward if `emcee` were integrated in `PyMC`.

