---
layout:     post
title:      Fast and easy pivot tables in pandas 0.5.0
subtitle:   转载自：http://wesmckinney.com/blog/fast-and-easy-pivot-tables-in-pandas-0-5-0/
date:       2011-10-23
author:     Wes McKinney
header-img: img/background0.jpg
catalog: true
tags:
    - tables
    - reshaping
    - reshape
    - pandas
    - indexing
---





** Sun 23 October 2011

 

> 
10/2/2015: Some API changes in pandas in the last 4 years but the general advice stands.


Over the last several months, I've invested a great deal in the [GroupBy](http://pandas.sourceforge.net/groupby.html) and [indexing](http://pandas.sourceforge.net/indexing.html#hierarchical-indexing-multiindex) infrastructure of [pandas](http://pandas.sourceforge.net/.). GroupBy in particular could still use more work to be made even higher performance, but even for quite large data sets, most users will find it more than satisfactory compared with other Python alternatives (which are mainly DIY approaches these days) or even in other data analysis packages, e.g. those in R, which I'll talk a bit about in this article.

An easy application of GroupBy is creating *pivot tables* from a tabular data set. This involves aggregating a data set on some number of keys, then reshaping it to form a 2D table with the stratified aggregated values. I added a new function `pivot_table` which provides a high level interface for creating pivot tables. Let's consider the `tips` data set used in some examples of the [Hadley Wickham's](http://had.co.nz/.) excellent R [reshape2](http://cran.r-project.org/web/packages/reshape2/index.html) package:

Since most readers won't have rpy2, you can get the data file [here](http://wesmckinney.com/files/tips.csv) and read it with:

All of this new functionality is available now on [GitHub](http://github.com/wesm/pandas) but will be a part of the upcoming pandas 0.5.0 release. Note that I am **only** using rpy2 here to pull the R data set into my Python sesson— all of the below code is implemented in pure Python (with a little Cython magic to make things fast).

### Pivot table basics

To use `pivot_table`, pass the pandas `DataFrame` and specify the column you wish to aggregate and the columns to group on the rows and columns of the table. Note the default aggregation is **mean**, though this can be specified:

Note that the returned object is still a `DataFrame`, so you can use all of the standard indexing technology to select portions of the resulting table:

If you don't specify a particular values column, it will try to aggregate all the other columns:

Other aggregations can be performed, like using `len` to get group counts:


 In [26]: pivot_table(tips, 'tip_pct', rows='sex', cols='smoker', aggfunc=len)Out[26]: smoker  No  Yessex              Female    54  33 Male      97  60


Once you've done the aggregation, you're free to use the built-in [reshaping capability](http://pandas.sourceforge.net/reshaping.html#reshaping-by-stacking-and-unstacking) to reshape the data in the table:

If you know a bit more about groupby, you can get clever and pass a dict of functions to perform multiple aggregations at once:

I thought that was pretty cool.

### Comparison with reshape2

R's reshape2 package relies on two functions, `melt` and `cast`, to do the reshaping. Its implementation is, at least in my opinion, a *slightly* more ad hoc approach than in pandas (the actual `pivot_table` function is only about 10 lines and basically falls out of the groupby and hierarchical-indexing based reshaping). However, it can take advantage of R's built-in formulas which makes the syntax very intuitive. Here are some of the same examples using reshape2:

R lacks hierarchical indexing as far as I know, so reshape2 munges the group labels together into a row label.

In R there is also the `xtabs` function for doing cross-tabulation:

`ftable` just creates a flat table which can be more easily viewed. This table could be created with pandas by:

### Performance

pandas is very fast as I've invested a great deal in optimizing the indexing infrastructure and other core algorithms related to things such as this. I don't have a lot of points of comparison, but here is a simple benchmark of reshape2 versus `pandas.pivot_table` on a data set with 100000 entries and 25 groups. Here is the R code for the benchmark:

Here is what the actual table looks like:

Here's the equivalent Python code (sans timings, which I'll do in IPython):

Similarly:

And the R timing

And pandas:

So it's about 3-4x faster than reshape2. This obviously depends on the data set and how you structure the aggregation. Here's a couple slightly different benchmarks on the same data:

and pandas:

I suspect one source of slowdown reshape/reshape2 approach is that the `melt` operation is very expensive, as is variable subsetting. However, it enables easier computation of group margins, something which I have not yet addressed (but will, eventually) in pandas.
