---
layout:     post
title:      Adventures in Aggregating Data
subtitle:   转载自：http://wesmckinney.com/blog/aggregating-data-adventures/
date:       2011-07-12
author:     Wes McKinney
header-img: img/background1.jpg
catalog: true
tags:
    - writing
    - write
    - data
    - market
    - options
---





** Tue 12 July 2011

 

I'm a big fan of [Interactive Brokers](http://interactivebrokers.com/.). Cheap trading, great APIs, lightning fast execution with no frills, designed for the professional trader. Perfect for people like me. Here's the background for this article: I started writing short-dated out-of-the-money [call options](http://en.wikipedia.org/wiki/Call_option) on my stock and ETF positions last year as a way to hedge my downside risk (while limiting upside) and maybe even make a little extra income on the side in this volatile and frequently sideways market. Recently I was looking over my brokerage statements and trying to get a grasp on my realized and mark-to-market PnL (profit-and-loss) this year and last since we're talking about equity positions plus options that expired in each month since the beginning of the year. After poring over the various forms of reports I can get from IB I concluded the quickest-and-dirtiest (not to mention the most fun) way was to write a little Python program to do it for me.

I'll spare you the munging bit of getting the data out of the HTML activity statement using [BeautifulSoup](http://pypi.python.org/pypi/BeautifulSoup/3.2.0) and skip to where I've scraped the relevant data into a [DataFrame](http://pandas.sourceforge.net/dataframe.html). Here's some faux data for illustration purposes:

So, I want to aggregate the Realized and MTM columns by Underlying and
by whether it was an equity or option instrument. Were this data in a SQL
table, this operation could be expressed extremely concisely:

But since I like doing interactive data analysis in Python (and loath
writing lots of SQL queries), I'd rather do this with [pandas](http://pandas.sourceforge.net/.) and also
produce some easier-to-read console output. Here's what I ended up with:

And it outputs exactly what I'm looking for:

It occurred to me after writing this code that, with some changes to the [GroupBy](http://pandas.sourceforge.net/groupby.html) functionality in pandas, this could be made *much easier*. Ideally I'd like to write:

I'll get to work on this in the [pandas repo](http://github.com/wesm/pandas).

Here's the [Gist](https://gist.github.com/1079577) of the full script
