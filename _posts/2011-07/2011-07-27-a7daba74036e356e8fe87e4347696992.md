---
layout:     post
title:      GroupBy-fu： improvements in grouping and aggregating data in pandas
subtitle:   转载自：http://wesmckinney.com/blog/groupby-fu-improvements-in-grouping-and-aggregating-data-in-pandas/
date:       2011-07-27
author:     Wes McKinney
header-img: img/background0.jpg
catalog: true
tags:
    - group_name
    - columns
    - groupby
    - functionality
    - functionally
---





** Wed 27 July 2011

 

A couple of weeks ago in my [inaugural blog post](http://wesmckinney.com/blog?p=8) I wrote about the state of GroupBy in pandas and gave an example application. However, I was dissatisfied with the limited expressiveness (see the end of the article), so I decided to invest some serious time in the groupby functionality in [pandas](http://pandas.sourceforge.net/.) over the last 2 weeks in beefing up what you can do. So this article is a part show-and-tell, part quick tutorial on the new features. Note that I haven't added a lot of this to the official documentation yet.

### GroupBy primer

GroupBy may be one of the least well-understood features in pandas. Let's consider a DataFrame (basically a labeled 2D array):

Here, the index (row labels) contains dates and the columns are names for each time series. When performing a groupby operation, we may different goals:

- Perform an aggregation, like computing the sum of mean of each group. Functionally this means applying a function to each group and putting the aggregated results into a DataFrame

- Slicing the DataFrame into chunks (groups) and then doing something with the slices

- Performing a transformation, like standardizing each group (computing the zscore)


So there are two tasks: first, grouping the data; second, doing something with the grouped data. As far as grouping, in a totally abstract sense we have to define some kind of mapping that assigns labels (one of the axes) into group buckets. A mapping could be one of many things:

- A Python function, to be called on each label

- A dict, containing {label : group_name} mappings

- An array the same length as the axis containing the group correspondences. This may often be one of the columns in a DataFrame, but need not be. Every other mapping type gets rendered to this form eventually.


So in the above data, let's say we wanted to group the data by year. Since the row labels are Python datetime objects, we can access the `year` attribute when calling `groupby`

This returns an object of type **GroupBy**. With this object, you can do a lot of things including: **iteration, aggregation,** or **transformation**. So we could **iterate** like so:

Or **aggregate** like so:

Or **transform groups** like so (here I standardize each group):

Some aggregations are so common that they're provided as instance methods on the GroupBy object:

For those with SQL experience, a DataFrame can be treated like an SQL table. As such, grouping 'by columns" is quite natural:

Note the presence of the "nuisance" **B** column when we group by **A**. I want this to work:

More on dealing with this below.

### New: Column selection

In my [last post](http://wesmckinney.com/blog?p=8) I mentioned wanting to be able to do a groupby-operation on a single column of a DataFrame using another column or set of columns as the groupers. So in the above example, what I want is:

This is too verbose / awkward for my tastes. So now you can do:

Behind the scenes, this simply passes the **C** column to a Series GroupBy object along with the already-computed grouping(s).

### New: Group by multiple columns / key functions

The ability to group by multiple criteria (just like SQL) has been one of my most desired GroupBy features for a long time. It's also very hard to implement efficiently. So I bit the bullet and carefully crafted Cython code to speedily do aggregations on data grouped by multiple columns. So now you can do:

Iteration with multiple groups flattens the key pairs:

As a less trivial example, I loaded some data from the [Bureau of Labor Statistics](http://www.bls.gov/.), which I'll write more about another time:

This data set has 118 unique series_id's and spans 22 years (the period column gives the month of observation), so we're talking about 2596 unique groups. Let's say we wanted to compute the mean value for each year, it's pretty simple with the improved groupby:

I was also pretty impressed with how fast this operation is (the power of Cython!):

I haven't compared this with an SQL engine (SQLite, MySQL, Postgres, ...) but I hope that it's competitive. If you call a non-Cythonized function, the speed goes down considerably:

**Edit:** It's also possible to pass multiple functions instead of column names or to mix and match column names with functions:

### New: Omitting "nuisance" columns

It's pretty common to group by a column and ignore other columns containing non-floating point data. It used to be that you'd get an error, forcing you to first drop the "nuisance" columns, e.g. suppose we only want to group by the **A** column here:

If you try to compute the mean of the **B** column, things won't quite work out:

To cope with this, so-called "nuisance" columns are now automatically dropped. While I don't like discarding information, I think "practicality beats purity" in this case:

### New: “auto-dispatching” to DataFrame / Series

Since very few functions in DataFrame and Series/TimeSeries are implemented on the GroupBy classes, you may wish to simply invoke a Series instance method on each group, let's say:

But since we're got Python at our disposal, it's relatively straightforward to override `__getattribute__` to wrap and dispatch calls to Series/DataFrame instance methods so you can do this:

Some of the more complicated methods, like the super-useful **describe** method can be used in fact:

For those interested, the internal code to do this dispatching is short and simple, by the way:

### Old but not well known: apply multiple functions

This has always been around but not well-known by many people. Suppose you want to apply multiple functions to a group and collect all the results. You can pass a dict of functions:

I have a mind to expand on this idea for DataFrame objects to get us closer to the full flexibility of SQL with Pythonic syntax. If anyone has ideas or suggestions please let me know.

### Conclusions

GroupBy is certainly not done. If you use these tools and find them useful, please let me know. If you can think of ways to make them better, that would be nice information too. I think it would be great to implement a full SQL engine on top of pandas (similar to the SAS "proc sql"), and this new GroupBy functionality gets us closer to that goal.
