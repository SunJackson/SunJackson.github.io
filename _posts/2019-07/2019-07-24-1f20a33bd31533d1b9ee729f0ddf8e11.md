---
layout:     post
catalog: true
title:      CPAT and the Rényi-Type Statistic; End-of-Sample Change Point Detection in R
subtitle:      转载自：http://feedproxy.google.com/~r/RBloggers/~3/fEtonOr7D_k/
date:      2019-07-24
author:      ntguardian
tags:
    - testing
    - tests
    - statistics
    - statistical
    - data
---





*This article is also available in PDF form.*

 I started my first research project as a graduate student when I was only in the MSTAT program at the University of Utah, at the very end of 2015 (or very beginning of 2016; not sure exactly when) with my current advisor, Lajos Horváth. While I am disappointed it took this long, I am glad to say that the project is finished and I am finally published.



 Our article, entitled “A new class of change point test statstics of Rényi type”, is available online, published by the *Journal of Business and Economic Statistics* (or *JBES*)[7](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#horvathricemiller19)), but is also available [16](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#renyi53)). These test statistics are tailored for detecting changes that occur near the ends of the sample rather than the middle of the sample. We show that these statistics do well when structural changes happen recently (or early) in the sample, better than other popular methods.

 My advisor, Lajos Horváth, and his former graduate student/assistant professor at the University of Waterloo Greg Rice developed the theory for this statistic and most of the paper had already been written when Prof. Horváth invited me to the project. I was responsible for all coding-related matters of the project, including implementing the statistics, developing and performing simulations and finding and applying the statistic to a data example. I learned a lot in the process. I was forced to learn how to organize code-intensive research projects, thus prompting ([9](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#miller18)) and ([13](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#miller19)). I learned how to write R packages and I continue to do so to organize my research projects.

 This project produced **CPAT**, a package for change point analysis. This package exists specifically for implementing test statistics of research interest to this project but should also be useful in general. It includes not only the Rényi-type statistic but also the CUSUM statistic, the Darling-Erdös statistic, instances of the ([6](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#hidalgoseo13)) statistic, and instances of the ([2](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#andrews03)) statistic. To my knowledge, this is the only implementation of our new statistic and the Andrews procedure in R.

 In this article I will be discussing change point testing (focusing on time series), the Rényi-type statistics, **CPAT**, and some examples. I will not go into full depth, including the theory of the statistic and the full simulation results; for that, see the paper we wrote. This topic was also the subject of my first Ph.D. oral defense ([10](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#miller18b)), and the slides can be viewed online.

 Suppose we have a series of data ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg1.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg1.gif?w=456)
. In change point hypothesis testing, some aspect of the distribution changes at some unknown point in time ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg2.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg2.gif?w=456)
 (where ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg3.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg3.gif?w=456)
). Often we ask whether the mean is constant over the sample or not. Let ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg4.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg4.gif?w=456)
. We wish to test 
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg5.gif?w=456&is-pending-load=1)

![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg5.gif?w=456)


against 
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg6.gif?w=456&is-pending-load=1)

![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg6.gif?w=456)


Critically, ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456)
 is unknown; if it were known, then we could simply use classic ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg8.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg8.gif?w=456)
-tests known since the turn of the century. Here, though, the location of ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456)
 is unknown. Thus, part of the challenge is determining which of ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg9.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg9.gif?w=456)
 and ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg10.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg10.gif?w=456)
 are true, and part of the challenge is estimating ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456)
.

 To some, checking for a change in ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg11.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg11.gif?w=456)
 is interesting. However, change point testing extends beyond checking for changes in the mean. In fact, change point testing can attempt to detect just about any structural change in a data set. For instance, we can check for changes in the variance of a data set, or changes in a linear regression model or a time series model. There are tests for changes in functional data and even for checking for changes in distribution.

 Why do people care about these things? I can easily see why an *online* test–where the test is attempting to detect changes as data flows in–would be interesting; I recently read of an online algorithm for detecting a change in distribution that sought to detect changes in *radiation levels* (a life-or-death matter in some cases) ([15](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#padillaetal19)). However, that’s not the context I’m discussing here; I’m interested in historical changes. Why is this of interest?

 First, there’s the classical example: change point testing was developed for quality control purposes. For example, a batch of widgets would be produced by a machine, and a change point test could determine if the machine ever became miscalibrated during production of the widgets. Beyond that, though, detecting a change point in a sample can be the first step to further research; the researcher would figure out why the change occurred after discovering it. There’s a third reason that every forecaster and user of time series should be aware of, though: most statistical methods using time series data require that the data be stationary, meaning that the properties of the data remain unchanging in the sample. One can hardly justify fitting a model to a data set when not all the data was produced by the same process. So change point testing checks for a particular type of pathology in data sets that everyone using time series data should watch out for.

 In this article I’m not interested in estimating ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456)
 but only in deciding between ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg9.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg9.gif?w=456)
 and ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg10.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg10.gif?w=456)
. Change point inference is a rich area of research and several statistics are already well known and actively used. One such statistic is the CUSUM statistic:

 ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg12.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg12.gif?w=456)
 

 ( ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg13.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg13.gif?w=456)
 is an estimator of the long-run variance of ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg14.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg14.gif?w=456)
; I’ll discuss this more later.) In short, the CUSUM statistic compares subsample means of a growing window of data to the overall mean of the sample. If a subsample of the data has a mean very different from the overall mean, the null hypothesis should be rejected.

 Let ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg15.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg15.gif?w=456)
 be a Wiener process and ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg16.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg16.gif?w=456)
 be a Brownian bridge. If ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg9.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg9.gif?w=456)
 is true, then the limiting distribution of (1) is the Kolmogorov distribution as ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg17.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg17.gif?w=456)
:

 ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg18.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg18.gif?w=456)
 

 This is the distribution we use for hypothesis testing. Additionally, we have some power results: if ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg10.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg10.gif?w=456)
 is true and ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg19.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg19.gif?w=456)
 for some ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg20.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg20.gif?w=456)
, then ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg21.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg21.gif?w=456)
. Not only that, ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg22.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg22.gif?w=456)
 may have the best power among all statistic with such ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456)
.

 In our paper we call such a ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456)
 “mid-sample” (even though in principle ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg23.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg23.gif?w=456)
 could be small). We were interested more in the case where, as ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg17.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg17.gif?w=456)
, ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg24.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg24.gif?w=456)
. We call such change points “early” or “late”. The CUSUM statistic is not as effective in those situations, but the subject of our paper was a statistic that is quite effective when the change is early or late:

 ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg25.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg25.gif?w=456)
 

 Here, ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg26.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg26.gif?w=456)
 is a trimming parameter such that ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg27.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg27.gif?w=456)
 but ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg28.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg28.gif?w=456)
. What the Rényi-type statistic does is compare the mean of the first part of the data to the mean of the rest of the data, in the latter part. If the difference between the mean of the former part of the data and the mean of the latter part becomes large in magnitude, the null hypothesis of no change should be rejected.

 In our paper we showed that, whem ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg9.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg9.gif?w=456)
 is true, then as ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg17.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg17.gif?w=456)
, ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg29.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg29.gif?w=456)
, where ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg30.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg30.gif?w=456)
 and ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg31.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg31.gif?w=456)
 are IID copies of ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg32.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg32.gif?w=456)
. This establishes the distribution for computing ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg33.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg33.gif?w=456)
-values. As for ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg10.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg10.gif?w=456)
, we gave conditions on ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456)
 such that when ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg10.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg10.gif?w=456)
 is true, then ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg34.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg34.gif?w=456)
. These conditions not only include most of those for which ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg21.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg21.gif?w=456)
, (such as when ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg19.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg19.gif?w=456)
), but also conditions not covered by the CUSUM statistic in which the change tends to be early or late in the sample. For example, it’s possible to show that, as ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg17.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg17.gif?w=456)
, the CUSUM statistic does not have power asymptotically when ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg35.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg35.gif?w=456)
 or when ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg36.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg36.gif?w=456)
 for ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg37.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg37.gif?w=456)
 1$">, but ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg38.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg38.gif?w=456)
 does when ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg26.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg26.gif?w=456)
 is chosen appropriately (letting ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg39.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg39.gif?w=456)
 or ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg40.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg40.gif?w=456)
 often works).

 As mentioned above, while testing for changes in the mean is nice, we want to check for structural changes not just in the mean but in for many statistics and models. And in fact we can. For example, let’s suppose we have a regression model:

 ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg41.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg41.gif?w=456)
 

 Here, ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg42.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg42.gif?w=456)
 is a stationary white noise process ( ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg43.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg43.gif?w=456)
 and ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg44.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg44.gif?w=456)
 has more than two moments) and ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg45.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg45.gif?w=456)
 is a sequence of stationary random vectors. We wish to test 
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg46.gif?w=456&is-pending-load=1)

![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg46.gif?w=456)


against 
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg47.gif?w=456&is-pending-load=1)

![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg47.gif?w=456)


In fact, to do so, all you need to do is:

Assume ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg9.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg9.gif?w=456)
 is true and compute an estimate ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg48.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg48.gif?w=456)
 of ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg49.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg49.gif?w=456)
; 
Compute the residuals of the model, ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg50.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg50.gif?w=456)
; and 
Compute ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg38.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg38.gif?w=456)
 using ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg51.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg51.gif?w=456)
 as your data. 

 This procedure does work; the statistic has the same limiting distribution under the null hypothesis as before and the test has power when the null hypothesis is false, if ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg52.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg52.gif?w=456)
 and ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg53.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg53.gif?w=456)
 also have an appropriate relationship (you can construct situations where the test does not have power, such as when ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg54.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg54.gif?w=456)
 and ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg53.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg53.gif?w=456)
 are orthogonal). The same procedure can be used with the CUSUM statistic, too, and both procedures have similar relationships to ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456&is-pending-load=1)
: the CUSUM statistic has better power when ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456)
 is mid-sample and the Rényi-type statistic has better power early/late sample.

 This idea–use the residuals of the estimated model you’re testing for a change in–works not just for regression models but for time series models, generalized method of moments models, and I’m sure others that we haven’t considered. Later I will demonstrate checking for changes in regression models.

 However, there is an issue I have ignored until now: ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg55.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg55.gif?w=456)
. This is an estimator for the long-run variance of the data. If the null hypothesis were true and there was no serial correlation in the data, one could simply use the sample variance computed on the entire sample. However, even in the uncorrelated case we use an estimator that is a consistent estimator even when the break point occurs at ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg56.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg56.gif?w=456)
 for every ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg8.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg8.gif?w=456)
. However, when working with time series data, we recommend using a kernel density estimator for the long-run variance.

 I will not repeat the estimator here since the formula is quite involved; you can look at the original paper if you’re interested. These estimators are generally robust to heteroskedasticity (such as GARCH behavior) and autocorrelation, though they are far from perfect. In our simulations, we observed significant size inflation when there was noticeable serial correlation in the data since these estimators tend to underestimate the long-run variance. This is not a problem of the Rényi-type statistic but any statistic relying on these estimators for long-run variance estimation. Additionally, practitioners should play around with the kernel and bandwidth parameters to get the best results, since some kernels/bandwidths work better in some situations than others.

 My contribution to this project was primarily coding, from developing the implementations of these statistics to performing simulations. The result is the package **CPAT** ([11](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#miller18c)), which is available both on CRAN and on GitHub.

 While above I mentioned only the CUSUM test and the Rényi-type test, we investigated other tests as well. For instance, we considered weighted/trimmed variants of the CUSUM test, the Darling-Erdös test, the Hidalgo-Seo test, and Andrews’ test. Many of these tests are available in some form in **CPAT**, and have similar interfaces when sensible.

Call me a dork, but I saw a message like this used by the package **mclust** ([17](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#scruccaetal16)) and Stata and I wanted to do so myself. I think it’s cool and I plan on making messages like these for my packages for no good reason (**MCHT** ([12](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#miller18d)) has a similar on-load message).

 Moving on, let’s create an artificial data set for playing with.

Right in the middle of the sample, the mean of the data switches from 0 to 1. Thus there is a change point in the mean.

Let’s first apply the CUSUM test using the function `CUSUM.test()`.

 All of the test functions, including `CUSUM.test()`, produce S1-class objects of class `htest`, the same objects that **stats** statistical testing functions produce.

 In this situation, the CUSUM test worked well; it rejected the null hypothesis of no change, as it should. It even made a good guess as to the location where the mean occured, estimating that ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg57.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg57.gif?w=456)
, which is close to the true location of 100. Okay, let’s try another data set.

This data set does not have a change in mean yet the CUSUM test rejected the null hypothesis. Why is that so? This is because the default procedure for estimating the long-run variance will not work if the data is serially correlated, and in this case ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg58.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg58.gif?w=456)
 with autocorrelation parameter ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg59.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg59.gif?w=456)
. We need to switch to kernel-based long-run variance estimation.

 To turn on kernel-based methods we only need to set `use_kernel_var = TRUE`, but there are additional choices to make. Specifically, we need to choose the kernel and the bandwidth. There are defaults but in general **CPAT** outsources kernel and bandwidth selection to functions from **cointReg** ([3](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#ascherslebenwagner16)). Thus they use a similar interface.

 The default is to use the Bartlett kernel and select the bandwidth using the method recommended by ([1](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#andrews91b)). We can switch to the quadratic-spectral kernel and the ([14](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#neweywest94)) method like so:

Now we get a much more reasonable ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg33.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg33.gif?w=456)
-value.

 Let’s work an example for detecting structural changes in linear regression models. Another package for change point detection is the package **strucchange** ([18](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#zeleisetal03)), and it provides a package tracking US income and expenditures. We can test for structural changes in expenditures like so:

Notice I set `use_kernel_var = TRUE`; there is some evidence of autocorrelation in the data, though this is a good option to turn on in general since we never know whether data is auto-correlated or not.

 Okay, enough about the CUSUM statistic: let’s discuss the Rényi-type statistic. Using the Rényi-type statistic works just like using the CUSUM statistic:

The Rényi-type statistic was also able to detect the change in mean in the first sample.2 It wasn’t as authoritative as the CUSUM test but it was not incorrect. How about the second sample when we turn on the kernel-based long-run variance estimation?

The Rényi-type statistic, though, has an additional parameter to set: the trimming parameter, which above was ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg60.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg60.gif?w=456)
. Here the parameter is called `kn`, and `HR.test()` expects a function be supplied to it.

We mentioned that the Rényi-type test shines when the change point occurs very early or late in the sample. Here is a demonstration:

Here the CUSUM statistic fails to detect the early structural change but the Rényi-type statistic does not.3In general, the CUSUM statistic will have better power when the change occurs near the middle of the sample, while the Rényi-type statistic will have better power when the change happens early or late.

 Let’s wrap up our introduction to `HR.test()` with a demonstration of testing for changes in regression models:

 Finally, let’s consider some other statistics available in **CPAT**. First, there’s the Darling-Erdös statistic. Let 
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg64.gif?w=456&is-pending-load=1)

![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg64.gif?w=456)


When ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg65.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg65.gif?w=456)
, this is known as the weighted CUSUM statistic, and in general, for ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg66.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg66.gif?w=456)
\frac{1}{2}$"> we know this as the weighted and trimmed CUSUM statistic.4 This version of the CUSUM statistic should handle early/late change points better, though our (unreported) simulations suggest that the Rényi-type statistic has better power in the extreme cases we considered. The Darling-Erdös statistic is 
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg67.gif?w=456&is-pending-load=1)

![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg67.gif?w=456)


where ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg68.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg68.gif?w=456)
. It exists in **CPAT** as `DE.test()`.

Then there’s the Hidalgo-Seo statistic, existing in **CPAT** as `HS.test()`. This function was designed for working with univariate data; one could try to use `HS.test()` for testing for changes in regression models as we did above, but that would not be using the same statistic that Hidalgo and Seo presented.5 Additionally, this function does not have the same interface as the others in **CPAT**; it does not use kernel-based methods for long-run variance estimation but uses the procedure presented in the paper where the residuals are allowed to follow an ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg69.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg69.gif?w=456)
 process. Thus, there is a parameter, `corr`, for controlling whether this approach is used or not (if not, the residuals are treated as if they are IID); `corr = FALSE` by default.

Finally, there’s Andrews’ test. This is the most distinct test of the ones presented here. The version implemented here is designed for detecting late changes in the sample *only*; there is not a version for early or mid-sample changes. Apparently at least one person uses this test, which was surprising to me; I thought it would be the least used. But since someone is using the test, I may need to implement these other versions of Andrews’ test; I give the people what they want!

 Andrews’ test does *not* test the same set of hypotheses we considered above; instead, the version for late changes claims, under the null hypothesis, that the change happens after some point ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg70.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg70.gif?w=456)
 in the sample, and that ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg71.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg71.gif?w=456)
 is known (but ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg7.gif?w=456)
 supposedly is not); in short, under ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg10.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg10.gif?w=456)
, ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg72.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg72.gif?w=456)
. We consider this an odd setup; if this were true and we knew where the change might happen, we could simply use a two-sample ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg8.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg8.gif?w=456)
-test (or the equivalent for, say, regression models) like students learn in statistics 101 classes and the resulting test would be, provably, *the most powerful test.*

 Nevertheless, **CPAT** supports this test via the `Andrews.test()` function. Different versions of the test will be used depending on the input. If the data is univariate, the version run will be specifically made for univariate data. `Andrews.test()` requires that the parameter ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg73.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg73.gif?w=456)
 be set, since this is a necessary input for the alternative hypothesis that cannot be guessed; this is the first point in the sample where a change could occur.

Andrews’ procedure does not worry about long-run variance estimation like the other statistics; this is because of the data-dependent subsampling procedure Andrews’ test uses for computing ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg33.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg33.gif?w=456)
-values. (The setup of the test may be silly, but the end result is fascinating!)

Andrews’ test was designed for detecting changes near the ends of the sample. In this last example, the change occurs in the last 5 observations, and I tell the test that the change will happen after observation 190.

Again, the Rényi-type statistic comes out on top.

 I mentioned that different versions of Andrews’ test will be used depending on the input. If the input to the test is a `data.frame`, then `Andrews.test()` will expect the user to supply a formula; it’s expecting to test for a structural change in a regression model.

 Now that I’ve shown how to use the main functions of **CPAT**, I want to demonstrate detecting structural change in a real-world context. There is an example in the paper that demonstrates that the Rényi-type statistic could have detected changes in the ([5](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#famafrench15)) five-factor model when estimated for a portfolio of banking stocks around the time of the 2008 financial crisis. Additionally, the functions presented here would have detected a change in the relationship between US worker productivity and compensation, which I wrote about before ([8](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#miller16)).

 Let’s look at a different example; beta. Consider a stock; let ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg74.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg74.gif?w=456)
 be the return of this stock at time ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg8.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg8.gif?w=456)
. Let ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg75.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg75.gif?w=456)
 be the risk-free rate of return (such as the return from US Treasury notes) and let ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg76.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg76.gif?w=456)
 be the market return (perhaps the return from investing in an S&P 500 index fund) at time ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg8.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg8.gif?w=456)
. If you’re familiar with finance, you may have heard of quantities such as alpha and beta. Alpha is the excess return of the stock over the market; that is, how much of a profit one gets for investing in the stock rather than the market (less the risk-free rate of return). Beta, on the other hand, measures how much the stock moves like the market. If a stock’s beta is zero, it has no relation with the market; if its beta is positive, the stock does well when the market does well on average; and if beta is negative, the stock does well when the market does poorly, on average. If the beta is above one, the stock is more sensitive to the market (so a beta of two suggests that if the market had a return 1% in excess of average, the stock should be 2% in excess of its own average), while a beta less than one suggests a stock less sensitive to the movements of the market (an analogous statement can be made for betas above or below negative one).

 I remember learning about beta in my mathematical finance class and a student asking “Why should beta be constant over time?” That’s a great observation, and one that I’m here to address. See, alpha and beta are computed by estimating parameter ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg77.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg77.gif?w=456)
 and ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg78.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg78.gif?w=456)
 (for alpha and beta, respectively) in the regression model

 ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg79.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg79.gif?w=456)
 

 Thus, checking that alpha and beta are constant over time equates to performing a change point hypothesis test. When estimating ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg78.gif?w=456&is-pending-load=1)
, it makes sense for people practicing quantitative finance to check for change points. If there is a change point (or perhaps more than one), then using more data won’t make the estimate of ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg78.gif?w=456&is-pending-load=1)
 better, since some of the data was data produced by a different ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg78.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg78.gif?w=456)
 than the most recent one.

 **CPAT** comes with a subset of the Fama-French factors needed for estimating Fama-French five-factor models. We will use only some of those factors here to compute the ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg78.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg78.gif?w=456)
 that most investors are familiar with. Since the data set also comes with estimates of the risk-free rate of return, we will use those as well.

 Now for the stock. Let’s study Valeant Pharmaceuticals (now known as Bausch Health, in an effort to escape the reputation they rightfully earned), the subject of an episode of *Dirty Money* ([4](https://ntguardian.wordpress.com/2019/07/24/cpat-renyi-type-statistic-end-of-sample-change-point-detection-r/simpledoc.html#carr18)). Valeant had ticker symbol VRX (now BHC) and after 2008 it had a meteoric rise until Valeant’s business practices of buying drugs and hiking their prices to absurd, unaffordable levels–along with outright fraudulent behavior–attracted unwanted attention, preceding the collapse of the stock.
| ![](https://ntguardian.files.wordpress.com/2019/07/vrx.png?w=456&is-pending-load=1)![](https://ntguardian.files.wordpress.com/2019/07/vrx.png?w=456) |

 We can download the data for VRX from Quandl.

The Fama-French factors are stored in the `data.frame` `ff`. Let’s next create an object containing both VRX’s log returns and the Fama-French factors.

Let’s now compute the alpha and beta of VRX and test for structural change. Note that `RF` is the risk-free rate of return and `Mkt.RF` is the market return less the risk-free rate.

The CUSUM test does detect a change. Additionally, it believes the change happened in August 2015. This date is a good guess; the first bad news for Valeant occurred in October 2015, when a short seller named Andrew Left claimed that Valeant was engaging in perhaps illegal relations with a pharmacist named Philidor Rx Services.

 But that conclusion comes after having 2016 and 2017 data, when Valeant had clearly fallen from their “prime.” What if it was the end of 2015 and you were recalibrating your models then? Would you have detected a change from the CUSUM test? Or even the Darling-Erdös test?

 Let’s find out.

If you were just using the CUSUM test: no, you would not have noticed a change. The Darling-Erdös test is closer, but not convincing.

 How about the Rényi-type test?

Yes, you would have detected a change if you were using the Rényi-type statistic.

 First: how would I expect people to use the Rényi-type statistic in practice? Well, I’m not expecting the statistic to replace other statistics, such as the CUSUM statistic. The Rényi-type statistic has strengths not well emulated by other test statistics, but it also has relative weaknesses, too. My thought is that the test should be used along with those other tests. If both tests agree, cool; if they disagree, check where the tests suggest the change occurred and decide if you believe the test that rejected. And you should usually use kernel-based long-run variance estimation methods unless you have good reason not to do so.

 We are continuing to study the Rényi-type statistic and hope to get more publications from it. One issue I think we did not adequately address is how to select the trimming parameter. This is an important decision that can change the results of tests, and we don’t have any rigorous suggestions on how to pick the parameter other than ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg39.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg39.gif?w=456)
 and ![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg40.gif?w=456&is-pending-load=1)
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg40.gif?w=456)
 seem to work well, though one sometimes works better than the other.

 We have a lot of material for those who want to learn more about this subject. There’s the aforementioned paper that goes into more depth than this brief article, and gives more convincing evidence that our new statistic works well in early/late change contexts. Additionally, the **CPAT** archive contains a version of the package that includes not only the version of the software used for the paper but also the code that allows others to recreate and “play” with our simulations. (In other words I attempted to make our work reproducible.)

 If you’re using **CPAT**, I want to hear your feedback! I got feedback from one user and not only did it make my day it also gave me some idea of what I should be working on to release in future versions. And perhaps user questions will turn into future research.

 Finally, if you’re working with time series data and are unaware of or not performing change point analysis, I hope that this article was a good introduction to the subject and convinced you to start using these methods. As my example demonstrated, good change point detection can matter even in a monetary way. Using more data won’t help if the old data is no longer relevant.

3 

4 

5 

6 

7 

8 

9 

10 

11 

12 

13 

14 

15 

16 

17 

18 


**CPAT** and the Rényi-type Statistic: End-of-Sample Change Point Detection in R

 This document was generated using the LaTeX2HTML translator Version 2019 (Released January 1, 2019)

 The command line arguments were: latex2html -split 0 -nonavigation -lcase_tags -image_type gif simpledoc.tex

 The translation was initiated on 2019-07-23

---

#### Footnotes
![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg61.gif?w=456&is-pending-load=1)

![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg61.gif?w=456)

![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg62.gif?w=456&is-pending-load=1)

![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg62.gif?w=456)

![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg63.gif?w=456&is-pending-load=1)

![](https://ntguardian.files.wordpress.com/2019/07/cpatintroimg63.gif?w=456)


---

Packt Publishing published a book for me entitled *Hands-On Data Analysis with NumPy and Pandas*, a book based on my video course *Unpacking NumPy and Pandas*. This book covers the basics of setting up a Python environment for data analysis with Anaconda, using Jupyter notebooks, and using NumPy and pandas. If you are starting out using Python for data analysis or know someone who is, please consider buying my book or at least spreading the word about it. You can buy the book directly or purchase a subscription to Mapt and read it there.

If you like my blog and would like to support it, spread the word (if not get a copy yourself)!


*Related*







---
