---
layout:     post
title:      A O(n log n) NA-friendly time series "as of" using array operations
subtitle:   转载自：http://wesmckinney.com/blog/a-on-log-n-na-friendly-as-of-array-operations/
date:       2012-05-04
author:     Wes McKinney
header-img: img/background1.jpg
catalog: true
tags:
    - data
    - missing
    - fairly
---





** Fri 04 May 2012

 

In time series data, it's fairly common to need to compute the last known value "as of" a particular date. However, missing data is the norm, so it's a touch more complicated than doing a simple binary search. Here is an implementation using array operations that takes these things into account:

Some algorithmic notes. First, let's run this through `line_profiler` on a large time series to see where time is being taken up:

The main trickiness here is this step:

Since the indices returned by `searchsorted` are relative to the *filtered* values, you need to remap to what would have been the indices in the original array, and this does exactly that. Lastly, you might be interested in breaking up `stamps[mask].searchsorted(where, side='right')` to see how much time is spend in `stamps[mask]` versus `searchsorted`:

So, this could definitely be sped up by a factor or 2 or more by doing the whole operation in C or Cython, but it's nice to be able to express it concisely and speedily with array operations.
