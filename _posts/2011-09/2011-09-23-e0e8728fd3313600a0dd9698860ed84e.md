---
layout:     post
title:      NumPy indexing peculiarities
subtitle:   转载自：http://wesmckinney.com/blog/numpy-indexing-peculiarities/
date:       2011-09-23
author:     Wes McKinney
header-img: img/background1.jpg
catalog: true
tags:
    - september
    - fri
    - bad
    - pretty
    - curiously
---





** Fri 23 September 2011

 

Many scientific Python users are surprised when I tell them that `ndarray.take` is faster than __getitem__-based (a.k.a. "fancy" as I call it) [indexing](http://docs.scipy.org/doc/numpy/user/basics.indexing.html#index-arrays).

It's actually kind of unbelievable when you think about it. What's going on here that `take` is almost **10x faster**? I really should take a closer at the internals of what __getitem__ does because this has always struck me as pretty bad. Maybe I shouldn't be complaining? I mean, R 2.13's indexing falls somewhere in the middle:

So 656 microseconds per iteration. (In an earlier version of this post I used rpy2 to do the benchmark and got 1.05 ms, but there was apparently some overhead from rpy2)

Another peculiarity that I noticed with take is that performance
gets worse when you use the **out** argument, which tells the function to use
an array you pass in to write out the result:

**EDIT:** I've been informed that using `mode='clip'` or `mode='wrap'` makes this run as fast as without the out argument.

Weird! I was dissatisfied by this, so I got curious how fast a hand-coded little [Cython](http://cython.org/.) function can do this:

Don't worry about the -1 thing— that's a specialization that I'm using inside pandas. Curiously, this function is a lot faster than `take` using **out** but faster than the regular `take` by a handful of microseconds.

Very interesting.

### TL;DR

- Use `take` not `[]`-based indexing to get best performance

- Cython is just as fast for my specific application and a lot faster if you're passing an **out** array (which I will be for the application that I needed this for)

- R's `matrix` indexing performance is better than NumPy's fancy indexing, but about 5-6x slower than `ndarray.take`. This can probably be improved.

